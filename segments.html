<!DOCTYPE html>
<html lang="en">

<head>
    <title>M-Trada</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
    <link rel="stylesheet" href="css/style.css">
</head>

<body class="app">
    <header>
        <div class="container">
            <nav class="navbar navbar-expand-lg">
                <a class="navbar-brand" href="#">
                    <img src="img/logo.png" /> M-Trada
                </a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav ml-auto">
                        <li class="nav-item active">
                            <a class="nav-link" href="#">Projects</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                              Username
                            </a>
                            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                                <a class="dropdown-item" href="#">My Profile</a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item" href="#">Logout</a>
                            </div>
                        </li>
                    </ul>
                </div>
            </nav>
        </div>
    </header>

    <div class="main-content">
        <div class="container">
            <h1 class="page-title">Mark Segments</h1>

            <section>
                <div class="row">
                    <div class="col-md-7">
                        <div class="card">
                            <div class="card-header map-toolbar">
                                <button class="btn btn-add btn-secondary btn-add" id="btnAddSegment"><i class="fa fa-plus"></i>Add New</button>
                                <div class="secondary-actions float-right" style="display: none">
                                    <button class="btn btn-primary btn-add" id="btnSaveSegment" disabled="disabled">Save</button>

                                    <button class="btn btn-cancel btn-add" id="btnCancelSegment">Cancel</button>
                                </div>
                            </div>
                            <div class="">
                                <div class="wr-map no-action">
                                    <div id="map"></div>
                                </div>

                            </div>

                        </div>
                    </div>
                    <div class="col-md-5">
                        <table id="tbl-segments" class="table table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th>Segment</th>
                                    <th>Origin</th>
                                    <th>Destination</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="placeholder">
                                    <td colspan="3">
                                        No segments defined
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div id="contextmenu" class="fade">
                            <a id="edit">Edit</a>
                            <a id="delete">Delete</a>
                            <a href="">Add point from Origin</a>
                            <a href="">Add point from Destination</a>
                            <a href="">Duplicate</a>
                            <a href="">Duplicate and invert OD</a>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; UOW 2018</p>
        </div>
    </footer>




    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
    <script type="text/javascript" src="libs/gmaps/gmaps.js"></script>
    <script type="text/javascript">
        var map;
        var origin = null,
            destin = null,
            segment = 2;
        var segmentIndex = 0;
        $(document).ready(function() {
            map = new GMaps({
                el: '#map',
                lat: 6.9271,
                lng: 79.8612
            });

            GMaps.on('click', map.map, function(event) {
                var index = map.markers.length;
                var lat = event.latLng.lat();
                var lng = event.latLng.lng();

                if (segment < 2) {
                    console.log(segment);
                    if (origin === null && destin === null && segment < 1) {

                        $("#ori-lat").val(lat);
                        $("#ori-lon").val(lng);
                        origin = [lat, lng];

                        segment = 1;
                        map.addMarker({
                            lat: lat,
                            lng: lng,
                            title: 'Origin'
                        });
                        map.drawOverlay({
                            lat: lat,
                            lng: lng,
                            content: '<div class="marker-label"> ' + segmentIndex + ' </div>'
                        });
                    } else if (origin != null && destin === null && segment == 1) {
                        $("#des-lat").val(lat);
                        $("#des-lon").val(lng);
                        destin = [lat, lng];
                        map.addMarker({
                            lat: lat,
                            lng: lng,
                            title: 'Destination'
                        });
                        map.drawOverlay({
                            lat: lat,
                            lng: lng,
                            content: '<div class="marker-label"> ' + segmentIndex + ' </div>'
                        });
                        map.drawRoute({
                            origin: origin,
                            destination: destin,
                            travelMode: 'driving',
                            strokeColor: '#f0ab17',
                            strokeOpacity: 0.8,
                            strokeWeight: 4
                        });
                        $("#btnSaveSegment").removeAttr('disabled');
                        console.log("Segment -- " + origin + "---" + destin);

                    }

                }

            });


            map.setContextMenu({
                control: 'marker',
                options: [{
                    title: 'Center here',
                    name: 'center_here',
                    action: function(e) {
                        this.setCenter(e.latLng.lat(), e.latLng.lng());
                    }
                }]
            });

            $("#btnAddSegment").click(function() {
                segmentIndex++;
                segment = 0;
                origin = null;
                destin = null;

                $(".secondary-actions").show();
                $(".wr-map.no-action").removeClass("no-action");
                $("#tbl-segments tr.table-active").removeClass("table-active");
                $("#btnAddSegment").attr("disabled", "disabled");
            });

            $("#btnSaveSegment").click(function() {
                var formatOrigin = origin.join(', ');
                var formatDestin = destin.join(', ');
                if ($("#tbl-segments tbody tr.placeholder").length) {
                    $("#tbl-segments tbody tr.placeholder").remove();
                }
                $("#tbl-segments tbody").append("<tr><td>" + segmentIndex + "</td><td>" + formatOrigin + "</td><td>" + formatDestin + "</td></tr>");
                $("#btnSaveSegment").attr("disabled", "disabled");
                $(".wr-map").addClass("no-action");
                $(".secondary-actions").hide();
                map.removeMarkers();
                map.removeOverlays();
                map.cleanRoute();
                $("#btnAddSegment").removeAttr('disabled');
            });


            $("#btnCancelSegment").click(function() {
                $(".wr-map").addClass("no-action");
                $(".secondary-actions").hide();
                segmentIndex--;
                map.removeMarkers();
                map.removeOverlays();
                map.cleanRoute();
                $("#btnAddSegment").removeAttr('disabled');
            });
        });

var currentRow;

        $(document).ready(function() {


              $('#contextmenu a#delete').on('click',function(e) {
                currentRow.remove();
              });

            $(document).on("contextmenu", "#tbl-segments tr", function(e) {
                currentRow = $(this);
                console.log(currentRow);
                var delay = 0;
                if ($('#contextmenu').hasClass('show')) delay = 100;
                e.preventDefault();
                $('#contextmenu').removeClass('show');
                // $('#contextmenu').addClass('');

                setTimeout(function() {
                    $('#contextmenu').css('top', e.clientY);
                    $('#contextmenu').css('left', e.clientX);
                    // $('#contextmenu').removeClass('is-fadingOut');
                    $('#contextmenu').addClass('show');
                }, delay);

            });

            $(document).on("click", function(e) {
                $('#contextmenu').removeClass('show');
            });

        });

    </script>
</body>

</html>
